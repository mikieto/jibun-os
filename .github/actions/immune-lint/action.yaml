---
name: immune-lint

inputs:
  quality_gate_path:
    required: true
    description: "Path to quality_gate.yaml in the caller repo"

runs:
  using: composite
  steps:
    # — 1) 必要なスクリプトだけを疎クローン —
    - name: Checkout immune-lint script
      uses: actions/checkout@v4
      with:
        repository: mikieto/jibun-os          # ⬅ スクリプト元リポ
        ref: main                             #   タグ固定なら v1 などに
        path: .tmp-jibun-os                  #   ワークスペース直下に配置
        sparse-checkout: |
          scripts/                           #   scripts/ 配下だけ取得
        sparse-checkout-cone-mode: false
        fetch-depth: 1                       #   最小履歴で高速化

    # — 2) Python 環境セットアップ —
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # — 3) 依存インストール —
    - name: Install dependencies
      run: pip install pyyaml python-dateutil
      shell: bash

    # — 4) Lint スクリプト実行 —
    - name: Run immune-lint
      run: python .tmp-jibun-os/scripts/immune_lint.py --gate "${{ inputs.quality_gate_path }}"
      shell: bash
